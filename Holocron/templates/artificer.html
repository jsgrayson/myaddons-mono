{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 text-warning">The Artificer</h1>
        <p class="lead text-muted">Master of Crafts. Optimizer of Concentration.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <ul class="nav nav-tabs" id="artificerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="concentration-tab" data-bs-toggle="tab"
                    data-bs-target="#concentration" type="button" role="tab">Concentration Solver</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="supply-tab" data-bs-toggle="tab" data-bs-target="#supply" type="button"
                    role="tab">Supply Chain</button>
            </li>
        </ul>

        <div class="tab-content p-4 border border-top-0 bg-dark" id="artificerTabContent">
            <!-- Concentration Solver -->
            <div class="tab-pane fade show active" id="concentration" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="text-info">Daily Cooldown Optimization</h3>
                    <button class="btn btn-outline-warning" onclick="loadConcentration()">Refresh Data</button>
                </div>
                <div id="concentrationResults">
                    <div class="text-center text-muted">Loading optimization data...</div>
                </div>
            </div>

            <!-- Supply Chain -->
            <div class="tab-pane fade" id="supply" role="tabpanel">
                <h3 class="text-success">Cross-Character Logistics</h3>
                <div class="input-group mb-3">
                    <input type="text" class="form-control bg-dark text-white" placeholder="Recipe ID (e.g. 370607)"
                        id="recipeInput" value="370607">
                    <input type="number" class="form-control bg-dark text-white" placeholder="Qty" id="qtyInput"
                        value="10">
                    <button class="btn btn-success" type="button" onclick="solveSupplyChain()">Solve Logistics</button>
                </div>
                <div id="supplyResults"></div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadConcentration() {
        const resultsDiv = document.getElementById('concentrationResults');
        resultsDiv.innerHTML = '<div class="spinner-border text-warning" role="status"></div>';

        try {
            const response = await fetch('/api/artificer/concentration');
            const data = await response.json();

            let html = `
        <table class="table table-dark table-hover">
            <thead>
                <tr>
                    <th>Recipe</th>
                    <th>Cost (Conc)</th>
                    <th>Profit Gain (R2->R3)</th>
                    <th>Gold / Point</th>
                </tr>
            </thead>
            <tbody>
        `;

            data.forEach(row => {
                html += `
            <tr>
                <td>${row.name}</td>
                <td>${row.concentration_cost}</td>
                <td class="text-success">+${row.profit_gain.toFixed(0)}g</td>
                <td><strong class="text-warning">${row.gold_per_concentration.toFixed(2)}g</strong></td>
            </tr>
            `;
            });

            html += '</tbody></table>';
            resultsDiv.innerHTML = html;

        } catch (error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    async function solveSupplyChain() {
        const recipeId = document.getElementById('recipeInput').value;
        const qty = document.getElementById('qtyInput').value;
        const resultsDiv = document.getElementById('supplyResults');

        resultsDiv.innerHTML = '<div class="spinner-border text-success" role="status"></div>';

        try {
            const response = await fetch(`/api/artificer/supply_chain?recipe_id=${recipeId}&qty=${qty}`);
            const data = await response.json();

            let html = `<h5 class="mt-3">Logistics for: ${data.recipe_name}</h5>`;

            if (data.mail_tasks.length > 0) {
                html += '<h6 class="text-info mt-3">Mail Tasks (Reagents Found on Alts)</h6><ul class="list-group">';
                data.mail_tasks.forEach(task => {
                    html += `
                <li class="list-group-item bg-dark text-white border-info d-flex justify-content-between">
                    <span>
                        <i class="bi bi-envelope"></i> 
                        Log into <strong>${task.from}</strong>
                    </span>
                    <span>
                        Mail <strong>${task.count}x ${task.item_name}</strong>
                        <small class="text-muted">(${task.container})</small>
                    </span>
                </li>
                `;
                });
                html += '</ul>';
            } else {
                html += '<div class="alert alert-secondary mt-2">No reagents found on alts.</div>';
            }

            if (data.shopping_list.length > 0) {
                html += '<h6 class="text-danger mt-3">Shopping List (Still Missing)</h6><ul class="list-group">';
                data.shopping_list.forEach(item => {
                    html += `
                <li class="list-group-item bg-dark text-white border-danger">
                    Buy <strong>${item.count}x ${item.name}</strong>
                </li>
                `;
                });
                html += '</ul>';
            }

            resultsDiv.innerHTML = html;

        } catch (error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    // Load on start
    document.addEventListener('DOMContentLoaded', loadConcentration);
</script>
{% endblock %}